# 开发计划 - PV Pile Integration 项目

## 📅 项目时间线

### Phase 1: 项目初始化 (预计 1-2 天)

**目标**: 搭建项目基础架构和开发环境

#### 任务清单
- [ ] 创建项目目录结构
  - [ ] 创建 `src/` 目录及其子目录
  - [ ] 创建 `tests/` 目录
  - [ ] 创建所有必要的 `__init__.py` 文件
- [ ] 设置依赖管理
  - [ ] 创建 `requirements.txt` 或 `pyproject.toml`
  - [ ] 配置主要依赖（streamlit, docker, opencv-python, numpy, pandas, matplotlib, scikit-learn）
  - [ ] 配置开发依赖（pytest, ruff, pytest-cov）
- [ ] 创建配置文件
  - [ ] 创建 `config.py` 包含所有配置项
  - [ ] 设置环境变量管理
- [ ] 创建基础 Streamlit 应用框架
  - [ ] 创建 `app.py` 基础结构
  - [ ] 实现文件上传组件
  - [ ] 创建基础布局（三个图像显示区域）
- [ ] 设置 Git 仓库
  - [ ] 创建 `.gitignore`
  - [ ] 初始化 Git（如果还没有）
- [ ] 验证 Docker 环境
  - [ ] 确认 PV Pile 容器可访问
  - [ ] 测试 Docker 连接

**验收标准**:
- 项目结构完整，所有目录和文件就位
- 依赖安装成功，无冲突
- Streamlit 应用可以启动并显示基础界面
- Docker 容器可以正常连接

---

### Phase 2: Docker 推理集成 (预计 2-3 天)

**目标**: 实现与 PV Pile Docker 容器的集成，完成推理调用和结果解析

#### 任务清单
- [ ] 实现 Docker 客户端模块 (`src/inference/docker_client.py`)
  - [ ] 实现容器状态检查函数
  - [ ] 实现 `run_docker_inference()` 函数
    - [ ] 通过 `docker exec` 或 Docker API 调用推理
    - [ ] 处理输入/输出路径映射
    - [ ] 实现超时和错误处理
    - [ ] 添加进度监控（可选）
  - [ ] 实现结果文件验证
- [ ] 实现结果解析模块 (`src/inference/result_parser.py`)
  - [ ] 实现 `parse_sahi_results()` 函数
  - [ ] 解析 COCO 格式 JSON
  - [ ] 提取检测框坐标（bbox 格式转换）
  - [ ] 提取置信度和类别信息
  - [ ] 实现数据验证和错误处理
- [ ] 创建数据模型
  - [ ] 定义 `Detection` 数据类（使用 dataclass 或 Pydantic）
  - [ ] 定义返回类型和接口规范
- [ ] 编写单元测试
  - [ ] `test_docker_client.py`: 测试 Docker 客户端（使用 mock）
  - [ ] `test_parser.py`: 测试 JSON 解析功能
  - [ ] 测试错误处理场景

**验收标准**:
- 可以成功调用 Docker 容器进行推理
- 能够正确解析 SAHI JSON 结果
- 所有测试通过
- 错误处理完善，有清晰的错误消息

---

### Phase 3: 可视化模块 (预计 2-3 天)

**目标**: 实现图像拼合和置信度颜色映射功能

#### 任务清单
- [ ] 实现置信度颜色映射 (`src/visualization/confidence_colors.py`)
  - [ ] 实现 `get_confidence_color()` 函数
  - [ ] 定义颜色阈值常量
  - [ ] 实现颜色到 RGB/BGR 的转换
  - [ ] 支持自定义颜色方案
- [ ] 实现图像拼合模块 (`src/visualization/image_stitcher.py`)
  - [ ] 实现 `stitch_detection_image()` 函数
  - [ ] 读取推理结果图像
  - [ ] 在原图上绘制检测框
  - [ ] 根据置信度应用颜色
  - [ ] 处理图像尺寸和坐标转换
  - [ ] 添加标签和置信度文本
- [ ] 集成到 Streamlit
  - [ ] 在 UI 中显示推理结果图像
  - [ ] 实现图像对比视图
  - [ ] 添加图像下载功能
- [ ] 编写单元测试
  - [ ] `test_visualization.py`: 测试颜色映射
  - [ ] 测试图像拼合功能（使用测试图像）
  - [ ] 测试边界情况（空检测、大图像等）

**验收标准**:
- 推理结果图像可以正确显示在原图上
- 置信度颜色映射正确（红/黄/绿）
- 图像拼合无失真或错位
- 所有测试通过

---

### Phase 4: 几何校正集成 (预计 3-4 天)

**目标**: 集成 SolarGeoFix 几何校正功能

#### 任务清单
- [ ] 研究 SolarGeoFix 代码结构
  - [ ] 理解 RANSAC 回归算法
  - [ ] 理解网格填充算法
  - [ ] 确定需要集成的模块
- [ ] 实现数据格式转换
  - [ ] 实现 SAHI JSON → SolarGeoFix 格式转换
  - [ ] 实现 SolarGeoFix 格式 → 可视化格式转换
  - [ ] 处理坐标系统转换
- [ ] 实现几何校正模块 (`src/geometry/corrector.py`)
  - [ ] 实现 `apply_geometric_correction()` 函数
  - [ ] 集成 RANSAC 回归
  - [ ] 集成网格填充算法
  - [ ] 处理校正结果
  - [ ] 实现统计信息计算（新增/删除检测数）
- [ ] 集成到 Streamlit
  - [ ] 在 UI 中显示校正结果
  - [ ] 显示统计信息（原始检测数、校正后检测数、变化）
  - [ ] 实现校正前后对比视图
- [ ] 编写单元测试
  - [ ] 测试格式转换功能
  - [ ] 测试几何校正算法（使用已知测试数据）
  - [ ] 测试边界情况

**验收标准**:
- 几何校正功能正常工作
- 校正结果可视化正确
- 统计信息准确
- 所有测试通过

---

### Phase 5: Streamlit UI 完善 (预计 2-3 天)

**目标**: 完善用户界面，提升用户体验

#### 任务清单
- [ ] 完善 UI 布局
  - [ ] 优化三个图像显示区域的布局
  - [ ] 实现响应式设计
  - [ ] 添加标题和说明文字
  - [ ] 实现最小化、治愈系配色方案（参考 Duolingo/Dailyo 风格）
- [ ] 实现参数配置面板
  - [ ] 切片大小配置（高度、宽度）
  - [ ] 置信度阈值配置
  - [ ] 重叠比例配置（可选）
  - [ ] 参数验证和默认值
- [ ] 实现交互功能
  - [ ] 推理触发按钮和状态管理
  - [ ] 进度指示器（推理进度、处理进度）
  - [ ] 结果显示切换（原图/推理结果/校正结果）
  - [ ] 错误消息显示
- [ ] 实现结果导出
  - [ ] 图像下载功能
  - [ ] JSON 结果导出
  - [ ] 统计信息导出（可选）
- [ ] 优化用户体验
  - [ ] 添加加载动画
  - [ ] 实现缓存机制（避免重复推理）
  - [ ] 添加使用说明和帮助文本
  - [ ] 优化错误提示信息

**验收标准**:
- UI 美观、易用
- 所有功能正常工作
- 错误处理友好
- 响应速度快

---

### Phase 6: 测试和优化 (预计 2-3 天)

**目标**: 全面测试、性能优化和文档完善

#### 任务清单
- [ ] 单元测试完善
  - [ ] 确保所有模块都有测试覆盖
  - [ ] 测试覆盖率 ≥ 80%
  - [ ] 修复所有测试失败
- [ ] 集成测试
  - [ ] 端到端流程测试（上传 → 推理 → 可视化 → 校正）
  - [ ] 错误处理测试（Docker 未运行、文件不存在等）
  - [ ] 边界情况测试（大图像、小图像、空检测等）
- [ ] 性能优化
  - [ ] 图像处理优化（使用多线程/异步处理）
  - [ ] 实现结果缓存机制
  - [ ] 优化内存使用
  - [ ] 性能基准测试
- [ ] 代码质量
  - [ ] 运行 `ruff check` 和 `ruff format`
  - [ ] 修复所有 linting 错误
  - [ ] 代码审查和重构（如需要）
- [ ] 文档完善
  - [ ] 更新 README.md
  - [ ] 添加 API 文档（docstrings）
  - [ ] 创建使用示例
  - [ ] 更新 AGENTS.md（如需要）

**验收标准**:
- 所有测试通过
- 代码质量检查通过
- 性能满足要求
- 文档完整

---

## 🎯 总体时间估算

- **Phase 1**: 1-2 天
- **Phase 2**: 2-3 天
- **Phase 3**: 2-3 天
- **Phase 4**: 3-4 天
- **Phase 5**: 2-3 天
- **Phase 6**: 2-3 天

**总计**: 12-18 个工作日（约 2.5-3.5 周）

## 📋 开发优先级

### 高优先级（核心功能）
1. Phase 1: 项目初始化
2. Phase 2: Docker 推理集成
3. Phase 3: 可视化模块（基础功能）
4. Phase 5: Streamlit UI（基础功能）

### 中优先级（增强功能）
1. Phase 4: 几何校正集成
2. Phase 3: 可视化模块（高级功能）
3. Phase 5: Streamlit UI（高级功能）

### 低优先级（优化）
1. Phase 6: 测试和优化

## 🔄 迭代开发建议

### 第一个迭代（MVP - 最小可行产品）
- Phase 1: 项目初始化
- Phase 2: Docker 推理集成（基础功能）
- Phase 3: 可视化模块（基础可视化）
- Phase 5: Streamlit UI（基础界面）

**目标**: 能够上传图像、运行推理、显示结果

### 第二个迭代（完整功能）
- Phase 2: Docker 推理集成（完善）
- Phase 3: 可视化模块（完善）
- Phase 4: 几何校正集成

**目标**: 完整的处理流程，包括几何校正

### 第三个迭代（优化和测试）
- Phase 5: Streamlit UI（完善）
- Phase 6: 测试和优化

**目标**: 生产就绪的应用

## 🚨 风险与挑战

### 技术风险
1. **Docker 集成复杂性**
   - 风险: Docker 容器通信可能不稳定
   - 缓解: 充分的错误处理和重试机制

2. **数据格式转换**
   - 风险: SAHI JSON 和 SolarGeoFix 格式不兼容
   - 缓解: 仔细研究两个项目的格式，编写详细的转换函数

3. **性能问题**
   - 风险: 大图像处理可能很慢
   - 缓解: 实现进度指示、缓存机制、异步处理

### 依赖风险
1. **PV Pile 容器可用性**
   - 风险: 容器可能未运行或配置错误
   - 缓解: 添加容器状态检查，提供清晰的错误消息

2. **SolarGeoFix 集成**
   - 风险: SolarGeoFix 代码可能需要修改才能集成
   - 缓解: 先研究代码结构，必要时创建适配层

## 📝 开发注意事项

1. **遵循编码规范**: 所有代码必须包含类型注解和文档字符串
2. **测试驱动**: 每个功能都应该有对应的测试
3. **错误处理**: 所有外部调用（Docker、文件操作）都必须有错误处理
4. **日志记录**: 关键操作应该记录日志，便于调试
5. **文档更新**: 每次重要更改后更新相关文档

## 🔗 相关资源

- **PV Pile 项目**: https://github.com/LeoAKALiu/pv_pile
- **SolarGeoFix 项目**: https://github.com/LeoAKALiu/SolarGeoFix
- **AGENTS.md**: 项目开发指南
- **INTEGRATION_PROJECT_README.md**: 项目说明文档

---

*创建日期: 2025-01-27*
*最后更新: 2025-01-27*

