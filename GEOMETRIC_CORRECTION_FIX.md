# 几何校正逻辑修复

## 🔍 问题描述

几何校正后检测数量激增：
- 原始检测数: 236
- 校正后检测数: 8662 (新增 8426)
- 问题：网格填充算法在整个图像上生成网格，导致添加了大量不相关的点

## ✅ 问题原因

`fill_grid()` 函数的逻辑问题：

1. **在整个图像上生成网格**:
   - 图像尺寸: 5280 × 3956
   - 网格间距: 50 像素
   - 生成的网格点数: (5280/50) × (3956/50) ≈ 8295 个点

2. **过滤逻辑不够严格**:
   - 阈值: `grid_spacing * 0.7 = 35.0` 像素
   - 由于现有点分布稀疏，大部分网格点都满足条件
   - 导致添加了约 8000+ 个不相关的点

## ✅ 修复方案

修改 `fill_grid()` 函数，使其**只在检测到的点附近填充缺失的点**：

### 1. 限制填充范围
- 计算现有点的边界框
- 只在边界框内生成网格（带小范围扩展）
- 扩展范围：从 `2 × grid_spacing` 改为 `1 × grid_spacing`（更保守）

### 2. 更严格的过滤条件
- 最小距离阈值：从 `0.3 × grid_spacing` 改为 `0.5 × grid_spacing`（避免重复）
- 最大距离阈值：从 `1.2 × grid_spacing` 改为 `0.9 × grid_spacing`（只在很近的范围内填充）

### 3. 空点处理
- 如果没有现有点，直接返回空数组（不应该填充整个图像）

## 📊 修复效果

### 修复前
- 原始检测数: 236
- 填充后点数: 8662
- 新增点数: 8426
- 增加比例: 3570%

### 修复后（第一次优化）
- 原始检测数: 236
- 填充后点数: 1036
- 新增点数: 800
- 增加比例: 339%

### 修复后（第二次优化 - 更保守）
- 原始检测数: 236
- 填充后点数: ~400-600（预估）
- 新增点数: ~200-400（预估）
- 增加比例: ~100-200%

## 🔧 代码变更

### `src/geometry/corrector.py`

1. **限制填充范围**:
   ```python
   # 扩展范围：从 2 × grid_spacing 改为 1 × grid_spacing
   margin = grid_spacing
   ```

2. **更严格的过滤条件**:
   ```python
   min_threshold = grid_spacing * 0.5  # 从 0.3 改为 0.5
   max_threshold = grid_spacing * 0.9  # 从 1.2 改为 0.9
   ```

3. **空点处理**:
   ```python
   if len(points) == 0:
       logger.warning("没有现有点，跳过网格填充")
       return points
   ```

### `tests/test_corrector.py`

更新测试以匹配新逻辑：
- `test_fill_grid_without_points`: 期望返回空数组（而不是填充整个图像）

## ✅ 验证

- ✅ 所有测试通过
- ✅ 填充后的点数更合理（不再激增）
- ✅ 只在检测点附近填充缺失的点

## 🚀 使用建议

1. **网格间距**: 根据实际检测对象的间距调整 `grid_spacing`
   - 如果检测对象间距约 50 像素，使用 `grid_spacing=50.0`
   - 如果检测对象间距约 100 像素，使用 `grid_spacing=100.0`

2. **禁用网格填充**: 如果不需要填充缺失的点，可以在 UI 中取消勾选 "使用网格填充"

3. **调整参数**: 如果需要更保守或更激进的填充，可以调整 `min_threshold` 和 `max_threshold`

---

*修复日期: 2025-01-27*



