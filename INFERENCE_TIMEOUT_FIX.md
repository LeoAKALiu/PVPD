# 推理超时问题修复

## 问题分析

### 失败原因

根据终端日志分析，推理失败的主要原因是**超时**：

1. **超时设置不足**：
   - 原超时时间：600秒（10分钟）
   - 对于超大图像（6144×8192像素），使用小切片（128×128）时，需要处理约4800个切片
   - 实际推理时间可能超过10分钟

2. **图像尺寸过大**：
   - 失败的图像：`微信图片_20260105102819_4_1381.jpg`
   - 图像尺寸：6144 × 8192 像素（约50M像素）
   - 切片参数：128 × 128（非常小）

3. **计算量估算**：
   - 使用128×128切片，重叠率0.2
   - 有效切片区域：102.4 × 102.4
   - 所需切片数：约 (6144/102.4) × (8192/102.4) ≈ 60 × 80 = **4,800个切片**
   - 每个切片推理时间：约0.1-0.5秒（取决于硬件）
   - 总推理时间：约480-2400秒（8-40分钟）

4. **之前的成功案例**：
   - 同一张图像之前成功过两次：
     - 91.15秒（可能使用了不同的切片参数）
     - 324.59秒
   - 最后一次超时（600秒）

## 修复方案

### 1. 动态超时计算

根据图像大小和切片参数动态计算超时时间：

```python
# 计算切片数量
effective_slice_height = slice_height * (1 - overlap_ratio)
effective_slice_width = slice_width * (1 - overlap_ratio)
num_slices_h = max(1, int((img_height - slice_height) / effective_slice_height) + 1)
num_slices_w = max(1, int((img_width - slice_width) / effective_slice_width) + 1)
total_slices = num_slices_h * num_slices_w

# 估算推理时间（每个切片约0.3秒，加上50%缓冲）
estimated_time = total_slices * 0.3 * 1.5

# 超时时间：估算时间的2倍，但不超过最大超时时间
dynamic_timeout = min(
    max(int(estimated_time * 2), config.DOCKER_TIMEOUT_SECONDS),
    config.DOCKER_TIMEOUT_MAX_SECONDS
)
```

### 2. 配置更新

在 `config.py` 中添加：

- `DOCKER_TIMEOUT_SECONDS = 600`：基础超时时间（10分钟）
- `DOCKER_TIMEOUT_MAX_SECONDS = 1800`：最大超时时间（30分钟，用于超大图像）

### 3. 日志增强

添加详细的日志输出，包括：
- 图像尺寸
- 切片数量
- 估算推理时间
- 实际超时设置

## 使用建议

### 对于超大图像（>4000×4000像素）

1. **增加切片尺寸**：
   - 推荐：640×640 或 1280×1280
   - 避免使用 128×128（会产生过多切片）

2. **调整重叠率**：
   - 可以适当降低重叠率（如0.1-0.15）
   - 减少切片数量，加快推理速度

3. **监控推理时间**：
   - 查看日志中的"估算时间"
   - 如果估算时间接近超时时间，考虑调整参数

### 示例计算

对于 6144×8192 图像：

| 切片尺寸 | 重叠率 | 切片数量 | 估算时间 | 推荐超时 |
|---------|--------|---------|---------|---------|
| 128×128 | 0.2    | ~4,800  | ~2,160s | 1800s   |
| 640×640 | 0.2    | ~200    | ~90s    | 600s    |
| 1280×1280 | 0.2  | ~50     | ~23s    | 600s    |

## 修改的文件

1. **`config.py`**：
   - 添加 `DOCKER_TIMEOUT_MAX_SECONDS = 1800`

2. **`src/inference/docker_client.py`**：
   - 添加动态超时计算逻辑
   - 根据图像尺寸和切片参数计算超时时间
   - 增强日志输出

## 测试建议

1. **小图像测试**（<2000×2000）：
   - 应使用默认超时（600秒）
   - 推理时间通常 < 60秒

2. **中等图像测试**（2000-4000像素）：
   - 动态超时应自动调整
   - 推理时间通常 < 300秒

3. **超大图像测试**（>4000像素）：
   - 应使用最大超时（1800秒）
   - 建议使用更大的切片尺寸（640×640或更大）

## 后续优化建议

1. **进度显示**：在UI中显示推理进度（已完成切片数/总切片数）
2. **参数建议**：根据图像尺寸自动推荐切片参数
3. **异步推理**：支持后台推理，避免阻塞UI
4. **缓存机制**：对相同图像和参数组合缓存结果

---

*修复日期：2025-01-05*



